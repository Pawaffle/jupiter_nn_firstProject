<html>
<head>
<title>Feature_Extraction_VGG16.ipynb</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #bcbec4;}
.s1 { color: #cf8e6d;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
.ls0 { height: 1px; border-width: 0; color: #43454a; background-color:#43454a}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
Feature_Extraction_VGG16.ipynb</font>
</center></td></tr></table>
<pre><span class="s0">#%% md 
# Feature extraction from VGG16 model <hr class="ls0">#%% 
</span><span class="s1">import </span><span class="s0">os</span>
<span class="s0">os</span><span class="s2">.</span><span class="s0">environ</span><span class="s2">[</span><span class="s3">'TF_ENABLE_ONEDNN_OPTS'</span><span class="s2">] = </span><span class="s3">'0'</span>

<span class="s1">import </span><span class="s0">shutil</span><span class="s2">, </span><span class="s0">pathlib</span>
<span class="s1">import </span><span class="s0">keras</span>
<span class="s1">import </span><span class="s0">matplotlib</span><span class="s2">.</span><span class="s0">pyplot </span><span class="s1">as </span><span class="s0">plt</span>
<span class="s1">import </span><span class="s0">numpy </span><span class="s1">as </span><span class="s0">np</span>
<span class="s1">from </span><span class="s0">keras </span><span class="s1">import </span><span class="s0">layers</span>
<span class="s1">from </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">utils </span><span class="s1">import </span><span class="s0">image_dataset_from_directory</span>
<span class="s1">from </span><span class="s0">google</span><span class="s2">.</span><span class="s0">colab </span><span class="s1">import </span><span class="s0">drive</span>

<span class="s0">drive</span><span class="s2">.</span><span class="s0">mount</span><span class="s2">(</span><span class="s3">'/content/drive'</span><span class="s2">)</span>
<span class="s4"># Assuming '800_800' is directly under 'My Drive'. Adjust the path if it's in a subfolder.</span>
<span class="s0">new_base_dir </span><span class="s2">= </span><span class="s0">pathlib</span><span class="s2">.</span><span class="s0">Path</span><span class="s2">(</span><span class="s3">&quot;/content/drive/My Drive/NeuroGroup8/PrWeek2-3/800_800&quot;</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% md 
After connecting to Google Drive and ensuring the model has access to our dataset, we can download the VGG16 model and examine its parameters <hr class="ls0">#%% 
conv_base </span><span class="s2">= </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">applications</span><span class="s2">.</span><span class="s0">vgg16</span><span class="s2">.</span><span class="s0">VGG16</span><span class="s2">(</span>
    <span class="s0">weights</span><span class="s2">=</span><span class="s3">&quot;imagenet&quot;</span><span class="s2">,</span>
    <span class="s0">include_top</span><span class="s2">=</span><span class="s1">False</span><span class="s2">,</span>
    <span class="s0">input_shape</span><span class="s2">=(</span><span class="s5">224</span><span class="s2">, </span><span class="s5">224</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>
<span class="s0">conv_base</span><span class="s2">.</span><span class="s0">summary</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% md 
Now that everything is downloaded and seems functional, we will adapt our dataset to the VGG input size of 224x224 pixels. <hr class="ls0">#%% 
train_dataset </span><span class="s2">= </span><span class="s0">image_dataset_from_directory</span><span class="s2">(</span>
    <span class="s0">new_base_dir </span><span class="s2">/ </span><span class="s3">&quot;train&quot;</span><span class="s2">,</span>
    <span class="s0">image_size </span><span class="s2">= (</span><span class="s5">224</span><span class="s2">, </span><span class="s5">224</span><span class="s2">),</span>
    <span class="s0">batch_size </span><span class="s2">= </span><span class="s5">32</span><span class="s2">)</span>
<span class="s0">validation_dataset </span><span class="s2">= </span><span class="s0">image_dataset_from_directory</span><span class="s2">(</span>
    <span class="s0">new_base_dir </span><span class="s2">/ </span><span class="s3">&quot;validation&quot;</span><span class="s2">,</span>
    <span class="s0">image_size </span><span class="s2">= (</span><span class="s5">224</span><span class="s2">, </span><span class="s5">224</span><span class="s2">),</span>
    <span class="s0">batch_size </span><span class="s2">= </span><span class="s5">32</span><span class="s2">)</span>
<span class="s0">test_dataset </span><span class="s2">= </span><span class="s0">image_dataset_from_directory</span><span class="s2">(</span>
    <span class="s0">new_base_dir </span><span class="s2">/ </span><span class="s3">&quot;test&quot;</span><span class="s2">,</span>
    <span class="s0">image_size </span><span class="s2">= (</span><span class="s5">224</span><span class="s2">, </span><span class="s5">224</span><span class="s2">),</span>
    <span class="s0">batch_size </span><span class="s2">= </span><span class="s5">32</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% md 
We got the message that all pictures are found within our 4 classes, so we can now extract features from them using the pre-trained VGG16 convolutional base. <hr class="ls0">#%% 
</span><span class="s1">def </span><span class="s0">get_features_and_labels</span><span class="s2">(</span><span class="s0">dataset</span><span class="s2">):</span>
    <span class="s0">all_features </span><span class="s2">= []</span>
    <span class="s0">all_labels </span><span class="s2">= []</span>
    <span class="s1">for </span><span class="s0">images</span><span class="s2">, </span><span class="s0">labels </span><span class="s1">in </span><span class="s0">dataset</span><span class="s2">:</span>
        <span class="s0">preprocessed_images </span><span class="s2">= </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">applications</span><span class="s2">.</span><span class="s0">vgg16</span><span class="s2">.</span><span class="s0">preprocess_input</span><span class="s2">(</span><span class="s0">images</span><span class="s2">)</span>
        <span class="s0">features </span><span class="s2">= </span><span class="s0">conv_base</span><span class="s2">.</span><span class="s0">predict</span><span class="s2">(</span><span class="s0">preprocessed_images</span><span class="s2">)</span>
        <span class="s0">all_features</span><span class="s2">.</span><span class="s0">append</span><span class="s2">(</span><span class="s0">features</span><span class="s2">)</span>
        <span class="s0">all_labels</span><span class="s2">.</span><span class="s0">append</span><span class="s2">(</span><span class="s0">labels</span><span class="s2">)</span>
    <span class="s1">return </span><span class="s0">np</span><span class="s2">.</span><span class="s0">concatenate</span><span class="s2">(</span><span class="s0">all_features</span><span class="s2">), </span><span class="s0">np</span><span class="s2">.</span><span class="s0">concatenate</span><span class="s2">(</span><span class="s0">all_labels</span><span class="s2">)</span>

<span class="s0">train_features</span><span class="s2">, </span><span class="s0">train_labels </span><span class="s2">= </span><span class="s0">get_features_and_labels</span><span class="s2">(</span><span class="s0">train_dataset</span><span class="s2">)</span>
<span class="s0">val_features</span><span class="s2">, </span><span class="s0">val_labels </span><span class="s2">= </span><span class="s0">get_features_and_labels</span><span class="s2">(</span><span class="s0">validation_dataset</span><span class="s2">)</span>
<span class="s0">test_features</span><span class="s2">, </span><span class="s0">test_labels </span><span class="s2">= </span><span class="s0">get_features_and_labels</span><span class="s2">(</span><span class="s0">test_dataset</span><span class="s2">)</span>

<span class="s0">train_features</span><span class="s2">.</span><span class="s0">shape</span><hr class="ls0"><span class="s0">#%% md 
With the (7, 7, 512) feature maps extracted from the VGG16 convolutional base, we can now build a new classification model using Keras. This model will consist of a Flatten layer to convert the 3D feature maps into 1D vectors, followed by a Dense layer with 256 units and a Dropout layer for regularization. Finally, a Dense output layer with 4 units (for our 4 classes) and a softmax activation will predict the class probabilities. We will then compile the model and display its summary to verify the architecture. <hr class="ls0">#%% 
inputs </span><span class="s2">= </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">Input</span><span class="s2">(</span><span class="s0">shape</span><span class="s2">=(</span><span class="s5">7</span><span class="s2">, </span><span class="s5">7</span><span class="s2">, </span><span class="s5">512</span><span class="s2">))</span>
<span class="s0">x </span><span class="s2">= </span><span class="s0">layers</span><span class="s2">.</span><span class="s0">Flatten</span><span class="s2">()(</span><span class="s0">inputs</span><span class="s2">)</span>
<span class="s0">x </span><span class="s2">= </span><span class="s0">layers</span><span class="s2">.</span><span class="s0">Dense</span><span class="s2">(</span><span class="s5">256</span><span class="s2">)(</span><span class="s0">x</span><span class="s2">)</span>
<span class="s0">x </span><span class="s2">= </span><span class="s0">layers</span><span class="s2">.</span><span class="s0">Dropout</span><span class="s2">(</span><span class="s5">0.5</span><span class="s2">)(</span><span class="s0">x</span><span class="s2">)</span>
<span class="s0">outputs </span><span class="s2">= </span><span class="s0">layers</span><span class="s2">.</span><span class="s0">Dense</span><span class="s2">(</span><span class="s5">4</span><span class="s2">, </span><span class="s0">activation</span><span class="s2">=</span><span class="s3">&quot;softmax&quot;</span><span class="s2">)(</span><span class="s0">x</span><span class="s2">)</span>
<span class="s0">model </span><span class="s2">= </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">Model</span><span class="s2">(</span><span class="s0">inputs</span><span class="s2">, </span><span class="s0">outputs</span><span class="s2">)</span>

<span class="s0">model</span><span class="s2">.</span><span class="s0">compile</span><span class="s2">(</span><span class="s0">loss</span><span class="s2">=</span><span class="s3">&quot;sparse_categorical_crossentropy&quot;</span><span class="s2">,</span>
              <span class="s0">optimizer</span><span class="s2">=</span><span class="s3">&quot;rmsprop&quot;</span><span class="s2">,</span>
              <span class="s0">metrics</span><span class="s2">=[</span><span class="s3">&quot;accuracy&quot;</span><span class="s2">])</span>

<span class="s0">model</span><span class="s2">.</span><span class="s0">summary</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% md 
After defining our classification model, we will train it using our extracted features and labels. We'll set up a ModelCheckpoint callback to automatically save the best version of our model (the one with the lowest validation loss) during the training process. This ensures that we retain the model that performs best on unseen data. <hr class="ls0">#%% 
callbacks </span><span class="s2">= [</span>
    <span class="s0">keras</span><span class="s2">.</span><span class="s0">callbacks</span><span class="s2">.</span><span class="s0">ModelCheckpoint</span><span class="s2">(</span>
        <span class="s0">filepath</span><span class="s2">=</span><span class="s3">&quot;feature_extraction.keras&quot;</span><span class="s2">,</span>
        <span class="s0">save_best_only</span><span class="s2">=</span><span class="s1">True</span><span class="s2">,</span>
        <span class="s0">monitor</span><span class="s2">=</span><span class="s3">&quot;val_loss&quot;</span><span class="s2">)</span>
<span class="s2">]</span>

<span class="s0">history </span><span class="s2">= </span><span class="s0">model</span><span class="s2">.</span><span class="s0">fit</span><span class="s2">(</span>
    <span class="s0">train_features</span><span class="s2">, </span><span class="s0">train_labels</span><span class="s2">,</span>
    <span class="s0">epochs</span><span class="s2">=</span><span class="s5">20</span><span class="s2">,</span>
    <span class="s0">validation_data</span><span class="s2">=(</span><span class="s0">val_features</span><span class="s2">, </span><span class="s0">val_labels</span><span class="s2">),</span>
    <span class="s0">callbacks</span><span class="s2">=</span><span class="s0">callbacks</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% md 
The following graphs display the training and validation accuracy, along with the training and validation loss over the epochs. <hr class="ls0">#%% 
accuracy </span><span class="s2">= </span><span class="s0">history</span><span class="s2">.</span><span class="s0">history</span><span class="s2">[</span><span class="s3">&quot;accuracy&quot;</span><span class="s2">]</span>
<span class="s0">val_accuracy </span><span class="s2">= </span><span class="s0">history</span><span class="s2">.</span><span class="s0">history</span><span class="s2">[</span><span class="s3">&quot;val_accuracy&quot;</span><span class="s2">]</span>
<span class="s0">loss </span><span class="s2">= </span><span class="s0">history</span><span class="s2">.</span><span class="s0">history</span><span class="s2">[</span><span class="s3">&quot;loss&quot;</span><span class="s2">]</span>
<span class="s0">val_loss </span><span class="s2">= </span><span class="s0">history</span><span class="s2">.</span><span class="s0">history</span><span class="s2">[</span><span class="s3">&quot;val_loss&quot;</span><span class="s2">]</span>
<span class="s0">epochs </span><span class="s2">= </span><span class="s0">list</span><span class="s2">(</span><span class="s0">range</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s0">len</span><span class="s2">(</span><span class="s0">accuracy</span><span class="s2">)+</span><span class="s5">1</span><span class="s2">))</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">epochs</span><span class="s2">, </span><span class="s0">accuracy</span><span class="s2">, </span><span class="s0">label</span><span class="s2">=</span><span class="s3">&quot;Training accuracy&quot;</span><span class="s2">)</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">epochs</span><span class="s2">, </span><span class="s0">val_accuracy</span><span class="s2">, </span><span class="s0">label</span><span class="s2">=</span><span class="s3">&quot;Validation accuracy&quot;</span><span class="s2">)</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">legend</span><span class="s2">()</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">()</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">epochs</span><span class="s2">, </span><span class="s0">loss</span><span class="s2">, </span><span class="s0">label</span><span class="s2">=</span><span class="s3">&quot;Training loss&quot;</span><span class="s2">)</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">plot</span><span class="s2">(</span><span class="s0">epochs</span><span class="s2">, </span><span class="s0">val_loss</span><span class="s2">, </span><span class="s0">label</span><span class="s2">=</span><span class="s3">&quot;Validation loss&quot;</span><span class="s2">)</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">legend</span><span class="s2">()</span>
<span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span><hr class="ls0"><span class="s0">#%% md 
As you can see, the model achieved very good results, and it's possible that even fewer epochs (perhaps around 10) could have been sufficient to reach a similar performance level. <hr class="ls0">#%% 
test_model </span><span class="s2">= </span><span class="s0">keras</span><span class="s2">.</span><span class="s0">models</span><span class="s2">.</span><span class="s0">load_model</span><span class="s2">(</span><span class="s3">&quot;feature_extraction.keras&quot;</span><span class="s2">)</span>
<span class="s0">test_loss</span><span class="s2">, </span><span class="s0">test_acc </span><span class="s2">= </span><span class="s0">test_model</span><span class="s2">.</span><span class="s0">evaluate</span><span class="s2">(</span><span class="s0">test_features</span><span class="s2">, </span><span class="s0">test_labels</span><span class="s2">)</span>
<span class="s0">print</span><span class="s2">(</span><span class="s3">f&quot;Test accuracy: </span><span class="s1">{</span><span class="s0">test_acc</span><span class="s1">:</span><span class="s3">.3f</span><span class="s1">}</span><span class="s3">&quot;</span><span class="s2">)</span><hr class="ls0"><span class="s0">#%% 
</span><span class="s1">import </span><span class="s0">numpy </span><span class="s1">as </span><span class="s0">np</span>
<span class="s1">import </span><span class="s0">matplotlib</span><span class="s2">.</span><span class="s0">pyplot </span><span class="s1">as </span><span class="s0">plt</span>

<span class="s0">print</span><span class="s2">(</span><span class="s3">&quot;--- Visualizing Errors ---&quot;</span><span class="s2">)</span>

<span class="s4"># 1. Määritellään luokat (varmista että nämä ovat oikeat)</span>
<span class="s4"># Jos sinulla on train_dataset muistissa, voit käyttää: class_names = train_dataset.class_names</span>
<span class="s1">if </span><span class="s3">'train_dataset' </span><span class="s1">in </span><span class="s0">locals</span><span class="s2">():</span>
    <span class="s0">class_names </span><span class="s2">= </span><span class="s0">train_dataset</span><span class="s2">.</span><span class="s0">class_names</span>
<span class="s1">else</span><span class="s2">:</span>
    <span class="s4"># Muuten määritellään käsin (TARKISTA JÄRJESTYS!)</span>
    <span class="s0">class_names </span><span class="s2">= [</span><span class="s3">'kuusi'</span><span class="s2">, </span><span class="s3">'marjakuusi'</span><span class="s2">, </span><span class="s3">'mänty'</span><span class="s2">, </span><span class="s3">'tuija'</span><span class="s2">]</span>

<span class="s4"># 2. Kerätään kaikki testikuvat listaksi, jotta voimme hakea niitä indeksillä</span>
<span class="s4"># TÄRKEÄÄ: Tämä olettaa, että test_dataset on ladattu shuffle=False -asetuksella!</span>
<span class="s0">print</span><span class="s2">(</span><span class="s3">&quot;Gathering images for visualization...&quot;</span><span class="s2">)</span>
<span class="s0">all_test_images </span><span class="s2">= []</span>
<span class="s1">for </span><span class="s0">img_batch</span><span class="s2">, </span><span class="s0">_ </span><span class="s1">in </span><span class="s0">test_dataset</span><span class="s2">:</span>
    <span class="s0">all_test_images</span><span class="s2">.</span><span class="s0">append</span><span class="s2">(</span><span class="s0">img_batch</span><span class="s2">.</span><span class="s0">numpy</span><span class="s2">())</span>
<span class="s0">all_test_images </span><span class="s2">= </span><span class="s0">np</span><span class="s2">.</span><span class="s0">concatenate</span><span class="s2">(</span><span class="s0">all_test_images</span><span class="s2">)</span>

<span class="s4"># 3. Tehdään ennusteet käyttäen `test_features` (koska malli on koulutettu piirteillä)</span>
<span class="s4"># Käytetään 'test_model' muuttujaa, joka on ladattu notebookissasi</span>
<span class="s0">print</span><span class="s2">(</span><span class="s3">&quot;Predicting outcomes...&quot;</span><span class="s2">)</span>
<span class="s0">predictions </span><span class="s2">= </span><span class="s0">test_model</span><span class="s2">.</span><span class="s0">predict</span><span class="s2">(</span><span class="s0">test_features</span><span class="s2">, </span><span class="s0">verbose</span><span class="s2">=</span><span class="s5">0</span><span class="s2">)</span>
<span class="s0">pred_indices </span><span class="s2">= </span><span class="s0">np</span><span class="s2">.</span><span class="s0">argmax</span><span class="s2">(</span><span class="s0">predictions</span><span class="s2">, </span><span class="s0">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>

<span class="s4"># 4. Varmistetaan labelien muoto</span>
<span class="s1">if </span><span class="s0">test_labels</span><span class="s2">.</span><span class="s0">ndim </span><span class="s2">&gt; </span><span class="s5">1</span><span class="s2">:</span>
    <span class="s0">true_indices </span><span class="s2">= </span><span class="s0">np</span><span class="s2">.</span><span class="s0">argmax</span><span class="s2">(</span><span class="s0">test_labels</span><span class="s2">, </span><span class="s0">axis</span><span class="s2">=</span><span class="s5">1</span><span class="s2">)</span>
<span class="s1">else</span><span class="s2">:</span>
    <span class="s0">true_indices </span><span class="s2">= </span><span class="s0">test_labels</span><span class="s2">.</span><span class="s0">astype</span><span class="s2">(</span><span class="s0">int</span><span class="s2">)</span>

<span class="s4"># 5. Etsitään virheet</span>
<span class="s0">error_indices </span><span class="s2">= </span><span class="s0">np</span><span class="s2">.</span><span class="s0">where</span><span class="s2">(</span><span class="s0">pred_indices </span><span class="s2">!= </span><span class="s0">true_indices</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
<span class="s0">print</span><span class="s2">(</span><span class="s3">f&quot;Found </span><span class="s1">{</span><span class="s0">len</span><span class="s2">(</span><span class="s0">error_indices</span><span class="s2">)</span><span class="s1">} </span><span class="s3">errors.&quot;</span><span class="s2">)</span>

<span class="s4"># 6. Piirretään virheet</span>
<span class="s0">num_errors_to_show </span><span class="s2">= </span><span class="s0">min</span><span class="s2">(</span><span class="s5">10</span><span class="s2">, </span><span class="s0">len</span><span class="s2">(</span><span class="s0">error_indices</span><span class="s2">))</span>

<span class="s1">for </span><span class="s0">k </span><span class="s1">in </span><span class="s0">range</span><span class="s2">(</span><span class="s0">num_errors_to_show</span><span class="s2">):</span>
    <span class="s0">idx </span><span class="s2">= </span><span class="s0">error_indices</span><span class="s2">[</span><span class="s0">k</span><span class="s2">]</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">figure</span><span class="s2">(</span><span class="s0">figsize</span><span class="s2">=(</span><span class="s5">8</span><span class="s2">, </span><span class="s5">3</span><span class="s2">))</span>

    <span class="s4"># --- KUVA ---</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">subplot</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">1</span><span class="s2">)</span>

    <span class="s4"># VGG16 preprocess_input muuttaa värit (esim. BGR ja negatiiviset arvot).</span>
    <span class="s4"># Tehdään nopea normalisointi (min-max scaling) jotta kuva näyttää järkevältä ihmissilmälle.</span>
    <span class="s0">img </span><span class="s2">= </span><span class="s0">all_test_images</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]</span>
    <span class="s0">display_img </span><span class="s2">= (</span><span class="s0">img </span><span class="s2">- </span><span class="s0">img</span><span class="s2">.</span><span class="s0">min</span><span class="s2">()) / (</span><span class="s0">img</span><span class="s2">.</span><span class="s0">max</span><span class="s2">() - </span><span class="s0">img</span><span class="s2">.</span><span class="s0">min</span><span class="s2">())</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">imshow</span><span class="s2">(</span><span class="s0">display_img</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">axis</span><span class="s2">(</span><span class="s3">'off'</span><span class="s2">)</span>

    <span class="s4"># --- ENNUSTE ---</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">subplot</span><span class="s2">(</span><span class="s5">1</span><span class="s2">, </span><span class="s5">2</span><span class="s2">, </span><span class="s5">2</span><span class="s2">)</span>
    <span class="s0">probs </span><span class="s2">= </span><span class="s0">predictions</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]</span>

    <span class="s0">bars </span><span class="s2">= </span><span class="s0">plt</span><span class="s2">.</span><span class="s0">bar</span><span class="s2">(</span><span class="s0">np</span><span class="s2">.</span><span class="s0">arange</span><span class="s2">(</span><span class="s0">len</span><span class="s2">(</span><span class="s0">class_names</span><span class="s2">)), </span><span class="s0">probs</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">xticks</span><span class="s2">(</span><span class="s0">np</span><span class="s2">.</span><span class="s0">arange</span><span class="s2">(</span><span class="s0">len</span><span class="s2">(</span><span class="s0">class_names</span><span class="s2">)), </span><span class="s0">class_names</span><span class="s2">, </span><span class="s0">rotation</span><span class="s2">=</span><span class="s5">45</span><span class="s2">, </span><span class="s0">ha</span><span class="s2">=</span><span class="s3">'right'</span><span class="s2">)</span>

    <span class="s4"># Värit: Punainen väärälle, Vihreä oikealle</span>
    <span class="s0">bars</span><span class="s2">[</span><span class="s0">pred_indices</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]].</span><span class="s0">set_color</span><span class="s2">(</span><span class="s3">'red'</span><span class="s2">)</span>
    <span class="s0">bars</span><span class="s2">[</span><span class="s0">true_indices</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]].</span><span class="s0">set_color</span><span class="s2">(</span><span class="s3">'green'</span><span class="s2">)</span>

    <span class="s0">pred_label </span><span class="s2">= </span><span class="s0">class_names</span><span class="s2">[</span><span class="s0">pred_indices</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]]</span>
    <span class="s0">true_label </span><span class="s2">= </span><span class="s0">class_names</span><span class="s2">[</span><span class="s0">true_indices</span><span class="s2">[</span><span class="s0">idx</span><span class="s2">]]</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylabel</span><span class="s2">(</span><span class="s3">&quot;Probability&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">title</span><span class="s2">(</span><span class="s3">f&quot;Pred: </span><span class="s1">{</span><span class="s0">pred_label</span><span class="s1">}\n</span><span class="s3">True: </span><span class="s1">{</span><span class="s0">true_label</span><span class="s1">}</span><span class="s3">&quot;</span><span class="s2">)</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">ylim</span><span class="s2">(</span><span class="s5">0</span><span class="s2">, </span><span class="s5">1.1</span><span class="s2">)</span>

    <span class="s0">plt</span><span class="s2">.</span><span class="s0">tight_layout</span><span class="s2">()</span>
    <span class="s0">plt</span><span class="s2">.</span><span class="s0">show</span><span class="s2">()</span></pre>
</body>
</html>